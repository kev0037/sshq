<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="/back.css">
  <script src="/back.js" defer></script>
  <title>Discord Message Sender</title>
  <style>
    body {
      background: #121212;
      color: #e0e0e0;
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 10px;
      background: #1e1e1e;
      text-align: center;
      color: #fff;
      border-bottom: 1px solid #333;
    }
    .controls {
      display: flex;
      gap: 10px;
      padding: 10px;
      background: #1e1e1e;
      flex-wrap: wrap;
      align-items: center;
    }
    input, button {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #2a2a2a;
      color: #fff;
      outline: none;
    }
    button {
      cursor: pointer;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .message {
      background: #1e1e1e;
      padding: 10px;
      border-radius: 8px;
      max-width: 70%;
      display: flex;
      gap: 10px;
    }
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
    }
    .content {
      flex: 1;
    }
    .username {
      font-weight: bold;
      margin-bottom: 4px;
    }
    .embed {
      border-left: 4px solid #2196f3;
      background: #2a2a2a;
      padding: 8px;
      margin-top: 6px;
      border-radius: 4px;
    }
    .message img,
    .embed img,
    .attachment img {
      max-width: 120px;
      max-height: 120px;
      border-radius: 6px;
      object-fit: cover;
      margin-top: 5px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .message img:hover,
    .embed img:hover,
    .attachment img:hover {
      transform: scale(1.05);
    }
    #send-area {
      display: flex;
      gap: 8px;
      padding: 10px;
      border-top: 1px solid #333;
      background: #1e1e1e;
      align-items: center;
      flex-wrap: wrap;
    }
    #message {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #2a2a2a;
      color: #fff;
      outline: none;
    }
    #delay {
      width: 60px;
    }
    /* File Upload Styling */
    .file-upload {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .file-label {
      background: #2a2a2a;
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid #333;
      transition: background 0.2s;
    }
    .file-label:hover {
      background: #3a3a3a;
    }
    #fileInput {
      display: none;
    }
    #file-name {
      font-size: 14px;
      color: #aaa;
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    /* Image Viewer Overlay */
    #image-viewer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    #image-viewer img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.8);
    }
    /* Logged in as info */
    #user-info {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      color: #ddd;
      margin-left: auto;
    }
    #user-info img {
      width: 28px;
      height: 28px;
      border-radius: 50%;
    }
    #user-info .username {
      font-weight: bold;
    }
    #user-info .userid {
      font-size: 12px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <header>Discord Message Sender</header>

  <div class="controls">
    <input type="password" id="token" placeholder="Bot/User Token">
    <button onclick="toggleToken()">üëÅ</button>
    <input type="text" id="channel" placeholder="Channel ID">
    <button onclick="connect()">Connect</button>
    <div id="user-info"></div>
  </div>

  <div id="chat"></div>

  <div id="send-area">
    <input type="text" id="message" placeholder="Type a message...">
    <button onclick="sendMessage()">Send</button>

    <div class="file-upload">
      <label for="fileInput" class="file-label">Choose File</label>
      <span id="file-name">No file chosen</span>
      <input type="file" id="fileInput">
    </div>

    <input type="number" id="delay" step="0.1" value="0.5" min="0.1">s
    <button onclick="sendFile()">Send File</button>
    <button onclick="stopSending()">Stop</button>
  </div>

  <!-- Image Viewer -->
  <div id="image-viewer" onclick="closeImage()">
    <img id="viewer-img" src="" alt="Full Image">
  </div>

  <script>
    let token = "";
    let channelId = "";
    let interval;
    let sending = false;

    function toggleToken() {
      const input = document.getElementById("token");
      input.type = input.type === "password" ? "text" : "password";
    }

    async function connect() {
      token = document.getElementById("token").value.trim();
      channelId = document.getElementById("channel").value.trim();

      if (!token || !channelId) {
        alert("Please enter token and channel ID");
        return;
      }

      clearInterval(interval);
      loadMessages();
      interval = setInterval(loadMessages, 5000);
      loadUserInfo();
    }

    async function loadMessages() {
      try {
        const res = await fetch(`https://discord.com/api/v10/channels/${channelId}/messages?limit=15`, {
          headers: { Authorization: token }
        });
        if (!res.ok) throw new Error("Failed to fetch messages");
        const data = await res.json();

        const chat = document.getElementById("chat");
        chat.innerHTML = "";
        data.reverse().forEach(m => {
          const div = document.createElement("div");
          div.className = "message";

          const avatar = m.author.avatar
            ? `https://cdn.discordapp.com/avatars/${m.author.id}/${m.author.avatar}.png?size=64`
            : `https://cdn.discordapp.com/embed/avatars/${m.author.discriminator % 5}.png`;

          div.innerHTML = `
            <img src="${avatar}" class="avatar">
            <div class="content">
              <div class="username">${m.author.username}</div>
              <div class="text">${m.content || ""}</div>
            </div>
          `;

          if (m.embeds && m.embeds.length > 0) {
            m.embeds.forEach(e => {
              const embedDiv = document.createElement("div");
              embedDiv.className = "embed";
              embedDiv.innerHTML = `
                <div><strong>${e.title || ""}</strong></div>
                <div>${e.description || ""}</div>
                ${e.image ? `<img src="${e.image.url}">` : ""}
              `;
              div.querySelector(".content").appendChild(embedDiv);
            });
          }

          if (m.attachments && m.attachments.length > 0) {
            m.attachments.forEach(att => {
              if (att.content_type && att.content_type.startsWith("image/")) {
                const img = document.createElement("img");
                img.src = att.url;
                img.className = "attachment";
                div.querySelector(".content").appendChild(img);
              } else {
                const link = document.createElement("a");
                link.href = att.url;
                link.textContent = att.filename;
                link.target = "_blank";
                div.querySelector(".content").appendChild(link);
              }
            });
          }

          chat.appendChild(div);
        });

        chat.scrollTop = chat.scrollHeight;
        enableImageClicks();
      } catch (err) {
        console.error("Error:", err);
      }
    }

    async function sendMessage(content) {
      const msg = content || document.getElementById("message").value.trim();
      if (!msg) return;
      try {
        const res = await fetch(`https://discord.com/api/v10/channels/${channelId}/messages`, {
          method: "POST",
          headers: {
            Authorization: token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ content: msg })
        });
        if (!res.ok) throw new Error("Failed to send message");
        if (!content) document.getElementById("message").value = "";
        loadMessages();
      } catch (err) {
        console.error("Send error:", err);
      }
    }

    async function sendFile() {
      const file = document.getElementById("fileInput").files[0];
      const delay = parseFloat(document.getElementById("delay").value) * 1000;
      if (!file) return alert("Please select a file");

      const text = await file.text();
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");

      let i = 0;
      sending = true;
      function sendNext() {
        if (!sending || i >= lines.length) {
          sending = false;
          return;
        }
        sendMessage(lines[i]);
        i++;
        setTimeout(sendNext, delay);
      }
      sendNext();
    }

    function stopSending() {
      sending = false;
    }

    function openImage(src) {
      const viewer = document.getElementById("image-viewer");
      const img = document.getElementById("viewer-img");
      img.src = src;
      viewer.style.display = "flex";
    }

    function closeImage() {
      document.getElementById("image-viewer").style.display = "none";
      document.getElementById("viewer-img").src = "";
    }

    document.addEventListener("keydown", e => {
      if (e.key === "Escape") closeImage();
    });

    function enableImageClicks() {
      document.querySelectorAll(".message img, .embed img, .attachment img").forEach(img => {
        img.onclick = e => {
          e.stopPropagation();
          openImage(img.src);
        };
      });
    }

    async function loadUserInfo() {
      try {
        const res = await fetch("https://discord.com/api/v10/users/@me", {
          headers: { Authorization: token }
        });
        if (!res.ok) throw new Error("Failed to fetch user info");
        const user = await res.json();

        const avatar = user.avatar
          ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=128`
          : `https://cdn.discordapp.com/embed/avatars/${user.discriminator % 5}.png`;

        const userInfo = document.getElementById("user-info");
        userInfo.innerHTML = `
          <div>Logged in as:</div>
          <img src="${avatar}" alt="avatar">
          <div class="username">${user.username}</div>
          <div class="userid">(${user.id})</div>
        `;
      } catch (err) {
        console.error("User info error:", err);
      }
    }

    // Update file name display
    document.getElementById("fileInput").addEventListener("change", function() {
      const fileName = this.files.length ? this.files[0].name : "No file chosen";
      document.getElementById("file-name").textContent = fileName;
    });
  </script>
</body>
</html>
